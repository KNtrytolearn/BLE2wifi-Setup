<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通过蓝牙BLE配置Wi-Fi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            transition: background-color 0.3s ease;
        }
        .status-disconnected { background-color: #ef4444; }
        .status-connecting { background-color: #f59e0b; animation: pulse 1.5s infinite; }
        .status-connected { background-color: #22c55e; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto p-6 md:p-8 bg-white dark:bg-slate-800 rounded-2xl shadow-lg">
        
        <div class="text-center">
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">蓝牙 Wi-Fi 配网</h1>
            <p class="mt-2 text-slate-500 dark:text-slate-400">为您的单板计算机配置无线网络。</p>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="mt-6 flex items-center justify-center p-3 bg-slate-100 dark:bg-slate-700 rounded-lg">
            <div id="statusDot" class="status-dot status-disconnected"></div>
            <span id="statusText" class="font-medium text-slate-600 dark:text-slate-300">未连接蓝牙设备</span>
        </div>

        <!-- Main Content -->
        <div class="mt-6">
            <!-- Step 1: Connect to BLE Device -->
            <div id="connect-section">
                <button id="connectBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    1. 扫描并连接设备
                </button>
            </div>
            
            <!-- Step 2: Wi-Fi Configuration Form -->
            <div id="config-section" class="hidden space-y-4 mt-6">
                <div>
                    <label for="ssid" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Wi-Fi 名称 (SSID)</label>
                    <input type="text" id="ssid" name="ssid" class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：MyHomeWiFi">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Wi-Fi 密码</label>
                    <input type="password" id="password" name="password" class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入您的Wi-Fi密码">
                </div>
                <button id="sendBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center space-x-2" disabled>
                    <span id="sendBtnText">2. 发送配置</span>
                    <div id="loader" class="hidden loader"></div>
                </button>
            </div>
        </div>

        <!-- Result/Status Message -->
        <div id="result-message" class="mt-6 text-center text-sm font-medium p-3 rounded-lg hidden"></div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const connectBtn = document.getElementById('connectBtn');
            const sendBtn = document.getElementById('sendBtn');
            const ssidInput = document.getElementById('ssid');
            const passwordInput = document.getElementById('password');
            const connectSection = document.getElementById('connect-section');
            const configSection = document.getElementById('config-section');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const resultMessage = document.getElementById('result-message');
            const sendBtnText = document.getElementById('sendBtnText');
            const loader = document.getElementById('loader');

            // --- BLE Configuration ---
            const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0";
            const SSID_CHAR_UUID = "12345678-1234-5678-1234-56789abcdef1";
            const PASSWORD_CHAR_UUID = "12345678-1234-5678-1234-56789abcdef2";
            const CONNECT_CHAR_UUID = "12345678-1234-5678-1234-56789abcdef3";
            const STATUS_CHAR_UUID = "12345678-1234-5678-1234-56789abcdef4";

            let bleDevice = null;
            let bleServer = null;
            let characteristics = {};

            const textEncoder = new TextEncoder();
            const textDecoder = new TextDecoder();

            // --- UI Update Functions ---
            const updateConnectionStatus = (status, text) => {
                statusDot.className = `status-dot ${status}`;
                statusText.textContent = text;
            };

            const showResultMessage = (type, message) => {
                resultMessage.textContent = message;
                resultMessage.className = `mt-6 text-center text-sm font-medium p-3 rounded-lg ${
                    type === 'success' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 
                    type === 'error' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                    'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
                }`;
                resultMessage.classList.remove('hidden');
            };

            const setLoading = (isLoading) => {
                sendBtn.disabled = isLoading;
                if (isLoading) {
                    sendBtnText.textContent = '处理中...';
                    loader.classList.remove('hidden');
                } else {
                    sendBtnText.textContent = '2. 发送配置';
                    loader.classList.add('hidden');
                }
            };
            
            // --- BLE Logic ---
            const onDisconnected = (event) => {
                console.log('设备已断开连接');
                updateConnectionStatus('status-disconnected', '设备已断开');
                connectSection.classList.remove('hidden');
                configSection.classList.add('hidden');
                sendBtn.disabled = true;
                bleDevice = null;
                bleServer = null;
                showResultMessage('error', '蓝牙连接已断开。');
            };
            
            const handleStatusNotification = (event) => {
                const value = event.target.value;
                const statusStr = textDecoder.decode(value);
                console.log(`收到状态更新: ${statusStr}`);
                
                if (statusStr.toLowerCase().startsWith('success')) {
                    showResultMessage('success', `配置成功！ ${statusStr}`);
                    setLoading(false);
                } else if (statusStr.toLowerCase().startsWith('failed')) {
                    showResultMessage('error', `配置失败: ${statusStr}`);
                    setLoading(false);
                } else {
                    showResultMessage('info', `设备状态: ${statusStr}`);
                }
            };

            connectBtn.addEventListener('click', async () => {
                if (!navigator.bluetooth) {
                    alert('抱歉，您的浏览器不支持Web Bluetooth。请在Android手机上使用Chrome浏览器。');
                    return;
                }

                try {
                    console.log('请求蓝牙设备...');
                    updateConnectionStatus('status-connecting', '正在扫描设备...');
                    
                    bleDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [SERVICE_UUID] }],
                        optionalServices: [SERVICE_UUID]
                    });

                    bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                    console.log('正在连接到GATT服务器...');
                    updateConnectionStatus('status-connecting', '正在连接...');
                    bleServer = await bleDevice.gatt.connect();

                    console.log('获取主服务...');
                    const service = await bleServer.getPrimaryService(SERVICE_UUID);

                    console.log('获取特征...');
                    const charUuids = [SSID_CHAR_UUID, PASSWORD_CHAR_UUID, CONNECT_CHAR_UUID, STATUS_CHAR_UUID];
                    const [ssidChar, passChar, connChar, statusChar] = await Promise.all(
                        charUuids.map(uuid => service.getCharacteristic(uuid))
                    );

                    characteristics = {
                        ssid: ssidChar,
                        password: passChar,
                        connect: connChar,
                        status: statusChar
                    };
                    
                    console.log('正在订阅状态通知...');
                    await characteristics.status.startNotifications();
                    characteristics.status.addEventListener('characteristicvaluechanged', handleStatusNotification);

                    console.log('连接成功！');
                    updateConnectionStatus('status-connected', `已连接到 ${bleDevice.name}`);
                    connectSection.classList.add('hidden');
                    configSection.classList.remove('hidden');
                    sendBtn.disabled = false;
                    resultMessage.classList.add('hidden');

                } catch (error) {
                    console.error('蓝牙连接失败:', error);
                    updateConnectionStatus('status-disconnected', '连接失败');
                    showResultMessage('error', `连接失败: ${error.message}`);
                }
            });

            sendBtn.addEventListener('click', async () => {
                const ssid = ssidInput.value.trim();
                const password = passwordInput.value;

                if (!ssid) {
                    showResultMessage('error', 'Wi-Fi名称(SSID)不能为空。');
                    return;
                }
                if (!bleDevice || !bleDevice.gatt.connected) {
                    showResultMessage('error', '蓝牙未连接。请重新连接设备。');
                    return;
                }

                try {
                    setLoading(true);
                    resultMessage.classList.add('hidden');

                    console.log(`正在写入SSID: ${ssid}`);
                    await characteristics.ssid.writeValue(textEncoder.encode(ssid));

                    console.log('正在写入密码...');
                    await characteristics.password.writeValue(textEncoder.encode(password));

                    console.log('发送连接命令...');
                    await characteristics.connect.writeValue(textEncoder.encode('1'));
                    
                    showResultMessage('info', '配置信息已发送，等待设备响应...');

                } catch (error) {
                    console.error('写入特征失败:', error);
                    showResultMessage('error', `发送失败: ${error.message}`);
                    setLoading(false);
                }
            });
        });
    </script>
</body>
</html>
